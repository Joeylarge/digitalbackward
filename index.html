<!DOCTYPE html> 
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>å€’åºæ•°å­—å¹¿åº¦æµ‹è¯•</title>
  <!-- å¼•å…¥ SheetJS ç”¨äºç”Ÿæˆ Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { margin: 0; padding: 20px; background: #f0f2f5; font-family: Arial, sans-serif; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 480px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; text-align: center; }
    p, h2 { margin: 12px 0; }
    #controls input { width: calc(50% - 12px); font-size: 18px; padding: 10px; margin: 6px; border: none; border-radius: 8px; background: #f7f7f7; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05); }
    #beforeTest { display:none; font-size:18px; margin:10px 0; }
    #digitDisplay { font-size:48px; margin:20px 0; min-height:1.2em; }
    #response { font-size:24px; padding:12px; width:100%; margin:10px 0; border:none; border-radius:8px; background:#f7f7f7; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05); text-align:center; }
    #keypad { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin:10px 0; }
    .key-btn { font-size:22px; padding:14px; background:#e9ecef; border:none; border-radius:8px; box-shadow:2px 2px 6px rgba(0,0,0,0.1), -2px -2px 6px rgba(255,255,255,0.7); user-select:none; text-align:center; }
    .key-btn:active { box-shadow: inset 2px 2px 6px rgba(0,0,0,0.1), inset -2px -2px 6px rgba(255,255,255,0.7); }
    button.control { width:100%; font-size:20px; padding:12px; margin-top:12px; border:none; border-radius:8px; background:linear-gradient(145deg,#6cb4ee,#3a87d7); color:#fff; box-shadow:4px 4px 10px rgba(0,0,0,0.15), -4px -4px 10px rgba(255,255,255,0.7); }
    button.control:disabled { background:#cccccc; box-shadow:none; color:#666; }
    .feedback { font-size:20px; font-weight:bold; margin-top:15px; min-height:1.2em; }
    #endMsg { display:none; font-size:20px; margin:20px 0; color:#333; }
    #resultContainer { display:none; margin-top:20px; }
    #resultContainer button { width:100%; font-size:20px; padding:12px; border:none; border-radius:8px; background:linear-gradient(145deg,#4dd39e,#2fa874); color:#fff; box-shadow:4px 4px 10px rgba(0,0,0,0.15), -4px -4px 10px rgba(255,255,255,0.7); }
    .alert-red { color: #e74c3c; font-weight: bold; }
    .highlight {background-color: yellow; font-weight: bold;}
    .copy-status {
  display: none;
  margin-top: 10px;
  font-size: 14px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  text-align: center;
}
.copy-status.show {
  display: block;
}
  </style>
</head>
<body>
  <div class="container">
    <!-- å¡«å†™ä¿¡æ¯ -->
    <div id="controls">
      <p>è¯·å¡«å†™å­¦å·å’Œç­çº§</p>
      <input type="text" id="studentId" placeholder="å­¦ç”ŸID" />
      <input type="text" id="studentClass" placeholder="ç­çº§" />
      <button id="btnStart" class="control">ä¸‹ä¸€æ­¥</button>
    </div>
    <!-- è¯´æ˜ -->
    <div id="intro" style="display:none;">
      <h2>è¯´æ˜</h2>
      <p>æœ¬æµ‹è¯•å°†ä¾æ¬¡å‘ˆç°â€œ+â€ï¼ˆæ³¨è§†ç‚¹ï¼‰å’Œå•ä¸ªæ•°å­—ï¼Œæ¯ä¸ªå‘ˆç°æ—¶é•¿ä¸º1ç§’ã€‚</p>
      <p>è¯·åœ¨æ¯ç»„ç»“æŸåï¼Œå°†åˆšæ‰å‡ºç°çš„æ•´ä¸ªæ•°å­—åºåˆ—æŒ‰<span class="highlight">å€’åº</span>é¡ºåºè¾“å…¥ã€‚</p>
      <p class="alert-red">æ³¨æ„âš ï¸ï¼šæµ‹è¯•ç»“æŸåï¼Œè¯·ä¿å­˜è‡³æœ¬åœ°æ–‡ä»¶å¤¹ï¼ä¹‹åè¿”å›æœ¬é¡µé¢æäº¤ã€‚</p>
      <p class="alert-red">æµ‹è¯•è¿‡ç¨‹ä¸­ç¦æ­¢åšç¬”è®°</p>
      <button id="btnWarmup" class="control">å¼€å§‹çƒ­èº«</button>
    </div>
    <!-- é¢„è¯•éªŒ çƒ­èº« -->
    <div id="warmup" style="display:none;">
      <h2>çƒ­èº«</h2>
      <button id="btnNextWarm" class="control" style="display:none;">æ­£ç¡®ï¼å¼€å§‹æ­£å¼å®éªŒ</button>
    </div>
    <!-- æ­£å¼æµ‹è¯• -->
    <p id="beforeTest">è¯·å€’åºè¾“å…¥å‘ˆç°çš„æ•°å­—</p>
    <div id="digitDisplay"></div>
    <div id="response"></div>
    <div id="keypad">
      <div class="key-btn" data-key="1">1</div>
      <div class="key-btn" data-key="2">2</div>
      <div class="key-btn" data-key="3">3</div>
      <div class="key-btn" data-key="4">4</div>
      <div class="key-btn" data-key="5">5</div>
      <div class="key-btn" data-key="6">6</div>
      <div class="key-btn" data-key="7">7</div>
      <div class="key-btn" data-key="8">8</div>
      <div class="key-btn" data-key="9">9</div>
      <div class="key-btn" data-key="æ¸…é™¤">æ¸…é™¤</div>
      <div class="key-btn" data-key="0">0</div>
      <div class="key-btn" data-key="åˆ é™¤">åˆ é™¤</div>
    </div>
    <button id="btnSubmit" class="control" disabled>æäº¤</button>
    <div class="feedback" id="feedback"></div>
    <!-- ç»“æŸä¸å¯¼å‡º -->
    <div id="endMsg"></div>
    <div id="resultContainer">
      <!-- å¯¼å‡ºæŒ‰é’® -->
    <button type="button" onclick="exportResults()">
    ğŸ“¥ å¯¼å‡º.xlsx å¹¶è¿”å›æäº¤
     </button>
    <!-- ä¸‹è½½å¤±è´¥æç¤º -->
    <p style="font-size:0.9em; color:#666; margin:0.5em 0;">
    å¦‚ä¸‹è½½å¤±è´¥ï¼Œè¯·å¤åˆ¶ä¸‹æ–¹å†…å®¹ï¼š
    </p>
    <!-- CSV æ–‡æœ¬æŒ‰é’® -->
    <button type="button" onclick="showCSV()">
    ğŸ“‹ æ˜¾ç¤ºCSVæ–‡æœ¬ä»¥å¤åˆ¶
   </button>
  </div>
    

   <!-- æ–°å¢ï¼šæ”¾ CSV æ–‡æœ¬çš„å®¹å™¨ -->
    <div id="csvContainer" style="display:none; margin-top:20px; text-align:left; position:relative;">
    <h3>è¯·å¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š</h3>
    <pre id="csvContent" style="white-space:pre-wrap; background:#fafafa; border:1px solid #ccc; padding:10px; border-radius:4px;"></pre>
    <button id="copyCsvBtn" class="control">ğŸ“‹ ä¸€é”®å¤åˆ¶</button>
    <div id="copyStatus" class="copy-status">âœ… å·²å¤åˆ¶ï¼</div>
   </div>
   </div>

  <script>
    const warmupTrials = ["418"];
    const trials = [
      {length:3,digits:["217","486","760"]},
      {length:4,digits:["3141","6351","2391"]},
      {length:5,digits:["14932","10646","74832"]},
      {length:6,digits:["934648","179390","408288"]},
      {length:7,digits:["4498237","2544371","8875085"]},
      {length:8,digits:["46229408","70967882","27139320"]},
      {length:9,digits:["368373442","576270919","688655957"]},
      {length:10,digits:["6432900801","8467348927","4184946413"]},
      {length:11,digits:["73290740563","74948772224","97084622072"]},
      {length:12,digits:["7329074056341","8493021746957","3629184750263"]},
      {length:13,digits:["93847265019284","17495028374659","32894756102938"]},
      {length:14,digits:["109283746592038","475920384756109","392847561029384"]},
      {length:15,digits:["1827364591028374","2948576102938475","3847561920384756"]}
    ];
    let stage='intro', warmup=0, attempts=0, level=0, trial=0, correctCount=0, showing=false, seqEndTime=0;
    let studentId="", studentClass="", records=[], reachedLen=0;
    const controlsEl=document.getElementById("controls"), introEl=document.getElementById("intro"), warmupEl=document.getElementById("warmup"), beforeEl=document.getElementById("beforeTest"), dispEl=document.getElementById("digitDisplay"), respEl=document.getElementById("response"), startBtn=document.getElementById("btnStart"), warmupBtn=document.getElementById("btnWarmup"), nextWarmBtn=document.getElementById("btnNextWarm"), subBtn=document.getElementById("btnSubmit"), fbEl=document.getElementById("feedback"), endMsgEl=document.getElementById("endMsg"), resultCon=document.getElementById("resultContainer"), idEl=document.getElementById("studentId"), classEl=document.getElementById("studentClass"), keys=document.querySelectorAll(".key-btn");
    keys.forEach(btn=>btn.addEventListener("click",()=>{if(showing||subBtn.disabled)return;const k=btn.dataset.key;if(k==="æ¸…é™¤")respEl.innerText="";else if(k==="åˆ é™¤")respEl.innerText=respEl.innerText.slice(0,-1);else respEl.innerText+=k;}));
    startBtn.addEventListener("click",()=>{studentId=idEl.value.trim();studentClass=classEl.value.trim();if(!studentId||!studentClass)return alert("è¯·å…ˆå¡«å†™å­¦ç”ŸIDå’Œç­çº§ï¼");controlsEl.style.display="none";introEl.style.display="block";});
    warmupBtn.addEventListener("click",()=>{introEl.style.display="none";warmupEl.style.display="block";beforeEl.style.display="block";stage='warmup';attempts=0;runWarmup();});
    nextWarmBtn.addEventListener("click",()=>{warmupEl.style.display="none";nextWarmBtn.style.display="none";beforeEl.innerText="è¯·å€’åºè¾“å…¥å‘ˆç°çš„æ•°å­—ã€‚";stage='test';runSequence();});
    subBtn.addEventListener("click",()=>{if(showing)return;const seqArr=stage==='warmup'?warmupTrials:trials[level].digits;const original=seqArr[stage==='warmup'?warmup:trial];const correctAns=original.split('').reverse().join('');const answer=respEl.innerText.trim();const rt=Date.now()-seqEndTime;if(stage!=='warmup'){records.push({length:trials[level].length,trial:trial+1,original,answer,correctAns,accurate:answer===correctAns?"æ˜¯":"å¦",rt});if(answer===correctAns)correctCount++;}fbEl.innerText=answer===correctAns?"âœ… æ­£ç¡®":`âŒ é”™è¯¯ï¼Œç­”æ¡ˆï¼š${correctAns}`;respEl.innerText="";subBtn.disabled=true;showing=true;setTimeout(()=>{if(stage==='warmup'){if(answer===correctAns){nextWarmBtn.style.display="block";}else{attempts++;if(attempts<5){fbEl.innerText="";showing=false;runWarmup();}else{nextWarmBtn.style.display="block";}}}else{trial++;if(trial===3){if(correctCount>=2){reachedLen=trials[level].length;level++;trial=0;correctCount=0;runSequence();}else{reachedLen=level>0?trials[level-1].length:0;endMsgEl.innerText=`æµ‹è¯•å·²ç»“æŸã€‚æ‚¨æœ€é•¿å›å¿† ${reachedLen} ä½æ•°å­—åºåˆ—ã€‚`;endMsgEl.style.display="block";resultCon.style.display="block";}}else{fbEl.innerText="";showing=false;runSequence();}}},800);});
    function runWarmup(){showing=true;subBtn.disabled=true;respEl.innerText="";beforeEl.innerText="è¯·å€’åºè¾“å…¥æ•°å­—ã€‚";const original=warmupTrials[warmup];const seq=["+",...original.split(''),"+"];let idx=0;const timer=setInterval(()=>{dispEl.innerText=seq[idx++];if(idx>seq.length-1){clearInterval(timer);setTimeout(()=>{dispEl.innerText="è¯·è¾“å…¥å€’åºæ•°å­—";showing=false;subBtn.disabled=false;seqEndTime=Date.now();},100);}},1000);}    
    function runSequence(){if(level>=trials.length){reachedLen=trials[trials.length-1].length;endMsgEl.innerText=`æµ‹è¯•å·²ç»“æŸã€‚æ‚¨æœ€é•¿å›å¿† ${reachedLen} ä½æ•°å­—åºåˆ—ã€‚`;endMsgEl.style.display="block";resultCon.style.display="block";return;}showing=true;subBtn.disabled=true;respEl.innerText="";beforeEl.innerText="è¯·å€’åºè¾“å…¥å‘ˆç°çš„æ•°å­—ã€‚";const original=trials[level].digits[trial];const seq=["+",...original.split(''),"+"];let idx=0;const timer=setInterval(()=>{dispEl.innerText=seq[idx++];if(idx>seq.length-1){clearInterval(timer);setTimeout(()=>{dispEl.innerText="è¯·è¾“å…¥å€’åºæ•°å­—";showing=false;subBtn.disabled=false;seqEndTime=Date.now();},100);}},1000);}    
    function exportResults(){const data=[["å­¦ç”ŸID",studentId],["ç­çº§",studentClass],[],["å…³å¡","è¯•æ¬¡","åŸå§‹æ•°å­—","è¾“å…¥ç­”æ¡ˆ","æ­£ç¡®ç­”æ¡ˆ","å‡†ç¡®","ååº”æ—¶é—´(ms)"],...records.map(r=>[r.length,r.trial,r.original,r.answer,r.correctAns,r.accurate,r.rt])];const ws=XLSX.utils.aoa_to_sheet(data),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Results");const wbout=XLSX.write(wb,{bookType:'xlsx',type:'binary'});function s2ab(s){const buf=new ArrayBuffer(s.length),view=new Uint8Array(buf);for(let i=0;i<s.length;i++)view[i]=s.charCodeAt(i)&0xFF;return buf;}const blob=new Blob([s2ab(wbout)],{type:"application/octet-stream"}),url=URL.createObjectURL(blob),link=document.createElement("a");link.href=url;link.download="result.xlsx";document.body.appendChild(link);link.click();document.body.removeChild(link);setTimeout(()=>{window.location.href="https://c.wss.pet/s/gt83u2qujtw";},2000);}  
      // â€¦ ä½ çš„ exportResults() å®šä¹‰ç»“æŸå â€¦

  // å°† records è¾“å‡ºæˆå¯å¤åˆ¶çš„ CSV æ–‡æœ¬
  function showCSV() {
    // å­¦å·å’Œç­çº§
    const sid = studentId;
    const sclass = studentClass;

    // æ„å»º CSV è¡Œ
    const rows = [
      ["å­¦ç”ŸID", sid],
      ["ç­çº§", sclass],
      [],
      ["å…³å¡","è¯•æ¬¡","åŸå§‹æ•°å­—","è¾“å…¥ç­”æ¡ˆ","æ­£ç¡®ç­”æ¡ˆ","å‡†ç¡®","ååº”æ—¶é—´(ms)"],
      ...records.map(r => [r.length, r.trial, r.original, r.answer, r.correctAns, r.accurate, r.rt])
    ];

    // æ‹¼æˆå­—ç¬¦ä¸²
    const csv = rows.map(r => r.join(",")).join("\n");

    // æ˜¾ç¤ºåˆ°é¡µé¢
    document.getElementById("csvContent").innerText = csv;
    document.getElementById("csvContainer").style.display = "block";
    const copyBtn = document.getElementById("copyCsvBtn");
const status = document.getElementById("copyStatus");

copyBtn.onclick = () => {
  navigator.clipboard.writeText(csv).then(() => {
    status.classList.add("show");
    setTimeout(() => status.classList.remove("show"), 2000);
  }).catch(err => {
    alert("å¤åˆ¶å¤±è´¥ï¼š" + err);
  });
};

    // å¯é€‰ï¼š20 ç§’åè‡ªåŠ¨è·³è½¬ï¼ˆå’Œå‰é¢ä¿æŒä¸€è‡´ï¼‰
    setTimeout(() => {
      window.location.href = "https://www.wjx.cn/vm/mBZc3BR.aspx";
    }, 20000);
  }
  </script>
</body>
</html>
